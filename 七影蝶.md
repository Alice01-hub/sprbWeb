# ä¸ƒå½±è¶åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°
ä¸ƒå½±è¶æ˜¯ç¥åŸŸé¡µé¢çš„æ ¸å¿ƒäº¤äº’å…ƒç´ ï¼Œåœ¨å¤œæ™šåœºæ™¯ä¸­éšæœºå‡ºç°ï¼Œä¸ºç”¨æˆ·æä¾›ä¸°å¯Œçš„å·¡ç¤¼ä¿¡æ¯å’Œäº’åŠ¨ä½“éªŒã€‚

## ä¸ƒå½±è¶ç±»å‹

### 1. å®˜æ–¹ä¸ƒå½±è¶
- ç”±ç³»ç»Ÿé¢„è®¾çš„5åªä¸ƒå½±è¶
- åŒ…å«å·¡ç¤¼ç½‘ç«™é“¾æ¥å’Œåœºæ™¯å›¾ç‰‡
- ä¸å¯ä¿®æ”¹ï¼Œå±äºå®˜æ–¹å†…å®¹

### 2. ç”¨æˆ·ä¸ƒå½±è¶
- æ¯ä¸ªç™»å½•ç”¨æˆ·å¯åˆ›å»ºä¸€åªä¸“å±ä¸ƒå½±è¶
- æ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜ã€å›¾ç‰‡å’Œé“¾æ¥
- å¯é‡å¤ç¼–è¾‘å’Œåˆ é™¤
- åœ¨åœºæ™¯ä¸­æ˜¾ç¤ºä¸ºé‡‘è‰²è¾¹æ¡†çš„ç‰¹æ®Šè´è¶

## ç»Ÿä¸€çš„ä¸ƒå½±è¶åˆ›å»ºæ ¼å¼

### æ ‡å‡†é…ç½®ç»“æ„
æ¯åªä¸ƒå½±è¶å¿…é¡»åŒ…å«ä»¥ä¸‹é…ç½®é¡¹ï¼š

```typescript
interface ButterflyConfig {
  label: string;        // æ‚¬åœæ—¶æ˜¾ç¤ºçš„æ ‡é¢˜
  hoverImg: string | null;  // æ‚¬åœæ—¶æ˜¾ç¤ºçš„å›¾ç‰‡è·¯å¾„
  modalImg: string | null;  // ç‚¹å‡»å¼¹çª—æ—¶æ˜¾ç¤ºçš„å›¾ç‰‡è·¯å¾„ï¼ˆé€šå¸¸ä¸hoverImgç›¸åŒï¼‰
  link: string | null;      // ç‚¹å‡»æ—¶è·³è½¬çš„é“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
}
```

### äº¤äº’è¡Œä¸ºè§„èŒƒ
1. **æ‚¬åœæ•ˆæœ**ï¼š
   - æ˜¾ç¤ºé…ç½®çš„`label`æ ‡é¢˜
   - æ˜¾ç¤ºé…ç½®çš„`hoverImg`å›¾ç‰‡
   - è´è¶ç¿…è†€æ‰‡åŠ¨åŠ é€Ÿ

2. **ç‚¹å‡»æ•ˆæœ**ï¼š
   - å¦‚æœ`link`ä¸ä¸ºnullï¼šç›´æ¥è·³è½¬åˆ°å¤–éƒ¨é“¾æ¥
   - å¦‚æœ`link`ä¸ºnullï¼šæ‰“å¼€å¼¹çª—æ˜¾ç¤º`modalImg`å›¾ç‰‡å’Œ`label`æ ‡é¢˜

### é…ç½®ç¤ºä¾‹
```typescript
// æœ‰å¤–éƒ¨é“¾æ¥çš„è´è¶ï¼ˆç‚¹å‡»è·³è½¬ï¼‰
{
  label: 'anitabiå·¡ç¤¼ç½‘ç«™',
  hoverImg: null,  // æ‚¬åœæ—¶ä¸æ˜¾ç¤ºå›¾ç‰‡
  modalImg: null,  // å¼¹çª—æ—¶ä¸æ˜¾ç¤ºå›¾ç‰‡
  link: 'https://anitabi.cn/map',  // ç‚¹å‡»è·³è½¬
}

// æ— å¤–éƒ¨é“¾æ¥çš„è´è¶ï¼ˆç‚¹å‡»å¼¹çª—ï¼‰
{
  label: 'ç©ºé—¨è‹ç¡è§‰çš„å°é“',
  hoverImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-è‹ç¡è§‰å°é“.webp',  // æ‚¬åœæ˜¾ç¤º
  modalImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-è‹ç¡è§‰å°é“.webp',  // å¼¹çª—æ˜¾ç¤º
  link: null,  // æ— è·³è½¬é“¾æ¥
}
```

## ç”¨æˆ·ä¸ƒå½±è¶åŠŸèƒ½

### æ•°æ®åº“è®¾è®¡
```sql
CREATE TABLE user_butterflies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    label VARCHAR(200) NOT NULL,
    hover_img VARCHAR(500),
    modal_img VARCHAR(500),
    link VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### APIæ¥å£

#### 1. è·å–ç”¨æˆ·ä¸ƒå½±è¶
```http
GET /api/butterfly/my-butterfly
Authorization: Bearer {token}
```

#### 2. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·ä¸ƒå½±è¶
```http
POST /api/butterfly/my-butterfly
Authorization: Bearer {token}
Content-Type: application/json

{
  "label": "æˆ‘çš„å·¡ç¤¼è®°å¿†",
  "hover_img": "/uploads/butterflies/1/hover_20250101_120000.jpg",
  "modal_img": "/uploads/butterflies/1/modal_20250101_120000.jpg",
  "link": "https://example.com"
}
```

#### 3. åˆ é™¤ç”¨æˆ·ä¸ƒå½±è¶
```http
DELETE /api/butterfly/my-butterfly
Authorization: Bearer {token}
```

#### 4. ä¸Šä¼ ä¸ƒå½±è¶å›¾ç‰‡
```http
POST /api/butterfly/upload-butterfly-image
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [å›¾ç‰‡æ–‡ä»¶]
image_type: "hover" | "modal"
```

### å‰ç«¯åŠŸèƒ½

#### ç”¨æˆ·ä¸ƒå½±è¶æ˜¾ç¤º
- ç™»å½•ç”¨æˆ·åœ¨åœºæ™¯å³ä¸‹è§’æ˜¾ç¤ºä¸“å±ä¸ƒå½±è¶
- é‡‘è‰²è¾¹æ¡†å’Œç‰¹æ®Šé˜´å½±æ•ˆæœ
- æ‚¬åœæ—¶æ”¾å¤§åŠ¨ç”»

#### ç¼–è¾‘ç•Œé¢
- æ ‡é¢˜è¾“å…¥ï¼ˆå¿…å¡«ï¼‰
- æ‚¬åœå›¾ç‰‡ä¸Šä¼ 
- å¼¹çª—å›¾ç‰‡ä¸Šä¼ 
- é“¾æ¥è¾“å…¥ï¼ˆå¯é€‰ï¼‰
- ä¿å­˜/åˆ é™¤/å–æ¶ˆæ“ä½œ

#### å›¾ç‰‡ä¸Šä¼ 
- æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼
- æ–‡ä»¶å¤§å°é™åˆ¶5MB
- è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³æ–‡ä»¶å
- æŒ‰ç”¨æˆ·IDåˆ†ç±»å­˜å‚¨

## æ ¸å¿ƒåŠŸèƒ½

### 1. è´è¶é…ç½®ç³»ç»Ÿ
ä¸ƒå½±è¶å…±æœ‰5åªå®˜æ–¹è´è¶ï¼Œæ¯åªéƒ½æœ‰ç‹¬ç‰¹çš„é…ç½®ï¼š

```typescript
const butterflyConfig = [
  {
    label: 'anitabiå·¡ç¤¼ç½‘ç«™',
    modalImg: null,
    hoverImg: null,
    link: 'https://anitabi.cn/map',
  },
  {
    label: 'ç©ºé—¨è‹ç¡è§‰çš„å°é“',
    modalImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-è‹ç¡è§‰å°é“.webp',
    hoverImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-è‹ç¡è§‰å°é“.webp',
    link: null,
  },
  {
    label: 'å°ç´¬çš„ç¯å¡”',
    modalImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-ç´¬çš„ç¯å¡”.webp',
    hoverImg: '/images/webps/ç”·æœ¨å²›/ç”·æœ¨å²›-ç´¬çš„ç¯å¡”.webp',
    link: null,
  },
  {
    label: 'é½é¡»åƒäººçš„å°çº¢ä¹¦å·¡ç¤¼ç¬”è®°',
    modalImg: null,
    hoverImg: null,
    link: 'https://www.xiaohongshu.com/discovery/item/67cb0ff80000000009015f05?source=webshare&xhsshare=pc_web&xsec_token=ABsqu3D76eAwSeSBQFe7MfGSblyZpnXnAJZN6ccVffjpg=&xsec_source=pc_share',
  },
  {
    label: 'ç©ºç™½çš„bç«™å·¡ç¤¼ç½‘ç«™è§†é¢‘ä»‹ç»',
    modalImg: null,
    hoverImg: null,
    link: 'https://www.bilibili.com/video/BV16pgBz7EAs/?spm_id_from=333.337.search-card.all.click&vd_source=88afb36e81beb22aa12c2c69722c5c7f',
  },
];
```

### 2. åŠ¨ç”»æ•ˆæœ

#### è´è¶ç¿…è†€åŠ¨ç”»
- ä½¿ç”¨ä¸¤å¸§å›¾ç‰‡å®ç°ç¿…è†€æ‰‡åŠ¨æ•ˆæœ
- åŠ¨ç”»å¸§ï¼š`ä¸ƒå½±ç¢Ÿ-3.webp` å’Œ `ä¸ƒå½±ç¢Ÿ-4.webp`
- æ­£å¸¸é€Ÿåº¦ï¼š320msé—´éš”
- æ‚¬åœåŠ é€Ÿï¼š120msé—´éš”
- æ¯åªè´è¶ç‹¬ç«‹æ§åˆ¶åŠ¨ç”»çŠ¶æ€

#### ä½ç½®éšæœºåŒ–
- æ¯æ¬¡åˆ·æ–°éšæœºç”Ÿæˆä¸é‡å çš„ä½ç½®
- é¿å…è´è¶ä¹‹é—´ç¢°æ’
- æœ€å°è·ç¦»ç®—æ³•ç¡®ä¿è§†è§‰æ•ˆæœ

### 3. äº¤äº’åŠŸèƒ½

#### æ‚¬åœæ•ˆæœ
- é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¿¡æ¯å¼¹çª—
- æ˜¾ç¤ºè´è¶å¯¹åº”çš„å·¡ç¤¼åœ°ç‚¹å›¾ç‰‡
- æ‚¬åœæ—¶è´è¶ç¿…è†€æ‰‡åŠ¨åŠ é€Ÿ
- å¼¹çª—åŒ…å«åœ°ç‚¹åç§°å’Œé¢„è§ˆå›¾

#### ç‚¹å‡»åŠŸèƒ½
- æœ‰é“¾æ¥çš„è´è¶ï¼šç›´æ¥è·³è½¬åˆ°å¤–éƒ¨ç½‘ç«™
- æ— é“¾æ¥çš„è´è¶ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¼¹çª—
- å¼¹çª—åŒ…å«å®Œæ•´çš„åœ°ç‚¹ä»‹ç»å’Œå›¾ç‰‡

### 4. æ˜¾ç¤ºæ§åˆ¶

#### éšæœºå±•ç¤º
- æ¯æ¬¡åˆ·æ–°éšæœºé€‰æ‹©80%çš„è´è¶æ˜¾ç¤º
- ç¡®ä¿è‡³å°‘æ˜¾ç¤º1åªè´è¶
- ä½¿ç”¨Fisher-Yatesæ´—ç‰Œç®—æ³•

#### å°ºå¯¸å˜åŒ–
æ¯åªè´è¶æœ‰ä¸åŒçš„å°ºå¯¸ï¼š
```typescript
const butterflySizes = [
  { w: 64, h: 64 },  // ç¬¬1åª
  { w: 56, h: 56 },  // ç¬¬2åª
  { w: 48, h: 48 },  // ç¬¬3åª
  { w: 54, h: 54 },  // ç¬¬4åª
  { w: 52, h: 52 },  // ç¬¬5åª
];
```

### 5. å¤œæ™šåœºæ™¯ç³»ç»Ÿ

#### èƒŒæ™¯å›¾ç‰‡
åŒ…å«20å¼ å¤œæ™šåœºæ™¯å›¾ç‰‡ï¼Œæ¶µç›–ï¼š
- ç”·æœ¨å²›ï¼šé¸Ÿç™½å²›å½¹åœºã€ç¯å¡”ã€é¸¥ç›¸é‡å°é“ã€æ³³æ± ã€è‹ç¡è§‰å°é“
- ç›´å²›ï¼šæ¸¯å£ã€æµ·æ°´æµ´åœºã€æµ·ç‹¸å®¶ã€å°å–éƒ¨ã€ç™½ç¾½é’“ç‚¹ã€ç¥ç¤¾ã€çµå¼¹
- å¥³æœ¨å²›ï¼šç§˜å¯†åŸºåœ°å±±è·¯ã€é‡‡çŸ³åœºå…¥å£ã€å±±é“

#### åˆ·æ–°æœºåˆ¶
- ç‚¹å‡»"ğŸŒ™ åˆ·æ–°å¤œæ™¯"æŒ‰é’®
- éšæœºé€‰æ‹©æ–°çš„å¤œæ™šåœºæ™¯
- é‡æ–°ç”Ÿæˆè´è¶ä½ç½®
- é‡æ–°éšæœºé€‰æ‹©æ˜¾ç¤ºçš„è´è¶

### 6. è§†è§‰æ•ˆæœ

#### æ˜Ÿç‚¹åŠ¨ç”»
- 80ä¸ªéšæœºåˆ†å¸ƒçš„æ˜Ÿç‚¹
- ä½¿ç”¨Framer Motionå®ç°æµ®åŠ¨åŠ¨ç”»
- æ¯ä¸ªæ˜Ÿç‚¹æœ‰ä¸åŒçš„æµ®åŠ¨å¹…åº¦å’ŒåŠ¨ç”»æ—¶é•¿
- è¥é€ å¤œæ™šæ˜Ÿç©ºæ°›å›´

#### è´è¶é˜´å½±
- ä½¿ç”¨CSS filterå®ç°drop-shadowæ•ˆæœ
- å¢å¼ºè´è¶çš„ç«‹ä½“æ„Ÿå’Œå±‚æ¬¡æ„Ÿ

### 7. çŠ¶æ€ç®¡ç†

#### è´è¶çŠ¶æ€
```typescript
// è´è¶ä½ç½®çŠ¶æ€
const [butterflyPositions, setButterflyPositions] = useState(...)

// å½“å‰å±•ç¤ºçš„è´è¶ç´¢å¼•
const [activeButterflies, setActiveButterflies] = useState<number[]>([0,1,2,3])

// æ§åˆ¶è´è¶å¼¹çª—æ˜¾ç¤º
const [showButterflyModal, setShowButterflyModal] = useState<0|1|2|3|4|5>(0)

// æ‚¬åœå¼¹çª—çŠ¶æ€
const [hoverButterfly, setHoverButterfly] = useState<0|1|2|3|4|5>(0)

// è´è¶åŠ¨ç”»å¸§ç´¢å¼•
const [butterflyFramesState, setButterflyFramesState] = useState<number[]>(...)

// è´è¶åŠ é€ŸçŠ¶æ€
const [butterflyFastArr, setButterflyFastArr] = useState<boolean[]>(...)

// ç”¨æˆ·ä¸ƒå½±è¶çŠ¶æ€
const [userButterfly, setUserButterfly] = useState<any>(null)
const [showUserButterflyModal, setShowUserButterflyModal] = useState(false)
const [userButterflyForm, setUserButterflyForm] = useState({
  label: '',
  hoverImg: '',
  modalImg: '',
  link: ''
})
```

### 8. æŠ€æœ¯å®ç°

#### å®šæ—¶å™¨ç®¡ç†
```typescript
useEffect(() => {
  const timers: number[] = [];
  for (let i = 0; i < BUTTERFLY_COUNT; i++) {
    const interval = butterflyFastArr[i] ? 120 : 320;
    timers[i] = window.setInterval(() => {
      setButterflyFramesState(prev => {
        const arr = [...prev];
        arr[i] = (arr[i] + 1) % butterflyFrames.length;
        return arr;
      });
    }, interval);
  }
  return () => { timers.forEach(t => window.clearInterval(t)); };
}, [butterflyFastArr]);
```

#### ä½ç½®è®¡ç®—ç®—æ³•
```typescript
function getRandomButterflyPositions() {
  const positions = [];
  let tries = 0;
  while (positions.length < BUTTERFLY_COUNT && tries < 200) {
    tries++;
    const left = Math.random() * 0.8 + 0.05;
    const top = Math.random() * 0.8 + 0.05;
    let overlap = false;
    for (let i = 0; i < positions.length; i++) {
      const dx = (left - positions[i].left) * mainImgMaxW * window.innerWidth;
      const dy = (top - positions[i].top) * mainImgMaxH * window.innerHeight;
      const minDist = (butterflySizes[positions.length].w + butterflySizes[i].w) / 2 + 12;
      if (dx * dx + dy * dy < minDist * minDist) {
        overlap = true;
        break;
      }
    }
    if (!overlap) positions.push({ left, top });
  }
  return positions;
}
```

## ç”¨æˆ·ä½“éªŒ

### äº¤äº’æµç¨‹
1. ç”¨æˆ·è¿›å…¥ç¥åŸŸé¡µé¢ï¼Œçœ‹åˆ°éšæœºå¤œæ™šåœºæ™¯
2. åœºæ™¯ä¸­éšæœºåˆ†å¸ƒç€å‡ åªå®˜æ–¹ä¸ƒå½±è¶
3. ç™»å½•ç”¨æˆ·å¯åœ¨å³ä¸‹è§’çœ‹åˆ°è‡ªå·±çš„ä¸“å±ä¸ƒå½±è¶
4. é¼ æ ‡æ‚¬åœè´è¶æ—¶ï¼Œæ˜¾ç¤ºå·¡ç¤¼åœ°ç‚¹ä¿¡æ¯
5. ç‚¹å‡»è´è¶å¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯æˆ–è·³è½¬å¤–éƒ¨é“¾æ¥
6. ç‚¹å‡»"åˆ›å»ºæˆ‘çš„ä¸ƒå½±è¶"æŒ‰é’®å¯åˆ›å»ºä¸“å±ä¸ƒå½±è¶
7. ç‚¹å‡»åˆ·æ–°æŒ‰é’®å¯é‡æ–°ç”Ÿæˆåœºæ™¯å’Œè´è¶

### è§†è§‰åé¦ˆ
- è´è¶ç¿…è†€æŒç»­æ‰‡åŠ¨ï¼Œè¥é€ ç”ŸåŠ¨æ„Ÿ
- æ‚¬åœæ—¶ç¿…è†€åŠ é€Ÿï¼Œæä¾›å³æ—¶åé¦ˆ
- å¼¹çª—åŠ¨ç”»å’Œé˜´å½±æ•ˆæœå¢å¼ºäº¤äº’ä½“éªŒ
- æ˜Ÿç‚¹æµ®åŠ¨è¥é€ å¤œæ™šæ°›å›´
- ç”¨æˆ·ä¸ƒå½±è¶é‡‘è‰²è¾¹æ¡†çªå‡ºæ˜¾ç¤º

## æŠ€æœ¯ç‰¹ç‚¹

1. **å“åº”å¼è®¾è®¡**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨å®šæ—¶å™¨ç®¡ç†åŠ¨ç”»ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **ç”¨æˆ·ä½“éªŒ**ï¼šä¸°å¯Œçš„è§†è§‰åé¦ˆå’Œäº¤äº’æ•ˆæœ
4. **å¯æ‰©å±•æ€§**ï¼šé…ç½®åŒ–çš„è´è¶ç³»ç»Ÿï¼Œæ˜“äºæ·»åŠ æ–°çš„å·¡ç¤¼åœ°ç‚¹
5. **éšæœºæ€§**ï¼šæ¯æ¬¡åˆ·æ–°éƒ½æœ‰ä¸åŒçš„ä½“éªŒ
6. **ä¸ªæ€§åŒ–**ï¼šæ”¯æŒç”¨æˆ·åˆ›å»ºä¸“å±ä¸ƒå½±è¶
7. **æ•°æ®æŒä¹…åŒ–**ï¼šç”¨æˆ·ä¸ƒå½±è¶æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­

## æ–‡ä»¶ç»“æ„

ç›¸å…³å›¾ç‰‡èµ„æºï¼š
- `/images/webps/ä¸ƒå½±ç¢Ÿ.webp` - é»˜è®¤å¤´åƒ
- `/images/webps/ä¸ƒå½±ç¢Ÿ-3.webp` - è´è¶åŠ¨ç”»å¸§1
- `/images/webps/ä¸ƒå½±ç¢Ÿ-4.webp` - è´è¶åŠ¨ç”»å¸§2
- `/images/webps/ç”·æœ¨å²›/` - ç”·æœ¨å²›ç›¸å…³åœºæ™¯å›¾ç‰‡
- `/images/webps/ç›´å²›/` - ç›´å²›ç›¸å…³åœºæ™¯å›¾ç‰‡
- `/images/webps/å¥³æœ¨å²›/` - å¥³æœ¨å²›ç›¸å…³åœºæ™¯å›¾ç‰‡
- `/uploads/butterflies/{user_id}/` - ç”¨æˆ·ä¸ƒå½±è¶å›¾ç‰‡å­˜å‚¨ç›®å½•
