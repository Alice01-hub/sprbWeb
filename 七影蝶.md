# 七影蝶功能文档

## 概述
七影蝶是神域页面的核心交互元素，在夜晚场景中随机出现，为用户提供丰富的巡礼信息和互动体验。

## 七影蝶类型

### 1. 官方七影蝶
- 由系统预设的5只七影蝶
- 包含巡礼网站链接和场景图片
- 不可修改，属于官方内容

### 2. 用户七影蝶
- 每个登录用户可创建一只专属七影蝶
- 支持自定义标题、图片和链接
- 可重复编辑和删除
- 在场景中显示为金色边框的特殊蝴蝶

## 统一的七影蝶创建格式

### 标准配置结构
每只七影蝶必须包含以下配置项：

```typescript
interface ButterflyConfig {
  label: string;        // 悬停时显示的标题
  hoverImg: string | null;  // 悬停时显示的图片路径
  modalImg: string | null;  // 点击弹窗时显示的图片路径（通常与hoverImg相同）
  link: string | null;      // 点击时跳转的链接（如果有）
}
```

### 交互行为规范
1. **悬停效果**：
   - 显示配置的`label`标题
   - 显示配置的`hoverImg`图片
   - 蝴蝶翅膀扇动加速

2. **点击效果**：
   - 如果`link`不为null：直接跳转到外部链接
   - 如果`link`为null：打开弹窗显示`modalImg`图片和`label`标题

### 配置示例
```typescript
// 有外部链接的蝴蝶（点击跳转）
{
  label: 'anitabi巡礼网站',
  hoverImg: null,  // 悬停时不显示图片
  modalImg: null,  // 弹窗时不显示图片
  link: 'https://anitabi.cn/map',  // 点击跳转
}

// 无外部链接的蝴蝶（点击弹窗）
{
  label: '空门苍睡觉的小道',
  hoverImg: '/images/webps/男木岛/男木岛-苍睡觉小道.webp',  // 悬停显示
  modalImg: '/images/webps/男木岛/男木岛-苍睡觉小道.webp',  // 弹窗显示
  link: null,  // 无跳转链接
}
```

## 用户七影蝶功能

### 数据库设计
```sql
CREATE TABLE user_butterflies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    label VARCHAR(200) NOT NULL,
    hover_img VARCHAR(500),
    modal_img VARCHAR(500),
    link VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### API接口

#### 1. 获取用户七影蝶
```http
GET /api/butterfly/my-butterfly
Authorization: Bearer {token}
```

#### 2. 创建或更新用户七影蝶
```http
POST /api/butterfly/my-butterfly
Authorization: Bearer {token}
Content-Type: application/json

{
  "label": "我的巡礼记忆",
  "hover_img": "/uploads/butterflies/1/hover_20250101_120000.jpg",
  "modal_img": "/uploads/butterflies/1/modal_20250101_120000.jpg",
  "link": "https://example.com"
}
```

#### 3. 删除用户七影蝶
```http
DELETE /api/butterfly/my-butterfly
Authorization: Bearer {token}
```

#### 4. 上传七影蝶图片
```http
POST /api/butterfly/upload-butterfly-image
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [图片文件]
image_type: "hover" | "modal"
```

### 前端功能

#### 用户七影蝶显示
- 登录用户在场景右下角显示专属七影蝶
- 金色边框和特殊阴影效果
- 悬停时放大动画

#### 编辑界面
- 标题输入（必填）
- 悬停图片上传
- 弹窗图片上传
- 链接输入（可选）
- 保存/删除/取消操作

#### 图片上传
- 支持常见图片格式
- 文件大小限制5MB
- 自动生成时间戳文件名
- 按用户ID分类存储

## 核心功能

### 1. 蝴蝶配置系统
七影蝶共有5只官方蝴蝶，每只都有独特的配置：

```typescript
const butterflyConfig = [
  {
    label: 'anitabi巡礼网站',
    modalImg: null,
    hoverImg: null,
    link: 'https://anitabi.cn/map',
  },
  {
    label: '空门苍睡觉的小道',
    modalImg: '/images/webps/男木岛/男木岛-苍睡觉小道.webp',
    hoverImg: '/images/webps/男木岛/男木岛-苍睡觉小道.webp',
    link: null,
  },
  {
    label: '小紬的灯塔',
    modalImg: '/images/webps/男木岛/男木岛-紬的灯塔.webp',
    hoverImg: '/images/webps/男木岛/男木岛-紬的灯塔.webp',
    link: null,
  },
  {
    label: '齐须千人的小红书巡礼笔记',
    modalImg: null,
    hoverImg: null,
    link: 'https://www.xiaohongshu.com/discovery/item/67cb0ff80000000009015f05?source=webshare&xhsshare=pc_web&xsec_token=ABsqu3D76eAwSeSBQFe7MfGSblyZpnXnAJZN6ccVffjpg=&xsec_source=pc_share',
  },
  {
    label: '空白的b站巡礼网站视频介绍',
    modalImg: null,
    hoverImg: null,
    link: 'https://www.bilibili.com/video/BV16pgBz7EAs/?spm_id_from=333.337.search-card.all.click&vd_source=88afb36e81beb22aa12c2c69722c5c7f',
  },
];
```

### 2. 动画效果

#### 蝴蝶翅膀动画
- 使用两帧图片实现翅膀扇动效果
- 动画帧：`七影碟-3.webp` 和 `七影碟-4.webp`
- 正常速度：320ms间隔
- 悬停加速：120ms间隔
- 每只蝴蝶独立控制动画状态

#### 位置随机化
- 每次刷新随机生成不重叠的位置
- 避免蝴蝶之间碰撞
- 最小距离算法确保视觉效果

### 3. 交互功能

#### 悬停效果
- 鼠标悬停时显示信息弹窗
- 显示蝴蝶对应的巡礼地点图片
- 悬停时蝴蝶翅膀扇动加速
- 弹窗包含地点名称和预览图

#### 点击功能
- 有链接的蝴蝶：直接跳转到外部网站
- 无链接的蝴蝶：显示详细信息弹窗
- 弹窗包含完整的地点介绍和图片

### 4. 显示控制

#### 随机展示
- 每次刷新随机选择80%的蝴蝶显示
- 确保至少显示1只蝴蝶
- 使用Fisher-Yates洗牌算法

#### 尺寸变化
每只蝴蝶有不同的尺寸：
```typescript
const butterflySizes = [
  { w: 64, h: 64 },  // 第1只
  { w: 56, h: 56 },  // 第2只
  { w: 48, h: 48 },  // 第3只
  { w: 54, h: 54 },  // 第4只
  { w: 52, h: 52 },  // 第5只
];
```

### 5. 夜晚场景系统

#### 背景图片
包含20张夜晚场景图片，涵盖：
- 男木岛：鸟白岛役场、灯塔、鸥相遇小道、泳池、苍睡觉小道
- 直岛：港口、海水浴场、海狸家、小卖部、白羽钓点、神社、灵弹
- 女木岛：秘密基地山路、采石场入口、山道

#### 刷新机制
- 点击"🌙 刷新夜景"按钮
- 随机选择新的夜晚场景
- 重新生成蝴蝶位置
- 重新随机选择显示的蝴蝶

### 6. 视觉效果

#### 星点动画
- 80个随机分布的星点
- 使用Framer Motion实现浮动动画
- 每个星点有不同的浮动幅度和动画时长
- 营造夜晚星空氛围

#### 蝴蝶阴影
- 使用CSS filter实现drop-shadow效果
- 增强蝴蝶的立体感和层次感

### 7. 状态管理

#### 蝴蝶状态
```typescript
// 蝴蝶位置状态
const [butterflyPositions, setButterflyPositions] = useState(...)

// 当前展示的蝴蝶索引
const [activeButterflies, setActiveButterflies] = useState<number[]>([0,1,2,3])

// 控制蝴蝶弹窗显示
const [showButterflyModal, setShowButterflyModal] = useState<0|1|2|3|4|5>(0)

// 悬停弹窗状态
const [hoverButterfly, setHoverButterfly] = useState<0|1|2|3|4|5>(0)

// 蝴蝶动画帧索引
const [butterflyFramesState, setButterflyFramesState] = useState<number[]>(...)

// 蝴蝶加速状态
const [butterflyFastArr, setButterflyFastArr] = useState<boolean[]>(...)

// 用户七影蝶状态
const [userButterfly, setUserButterfly] = useState<any>(null)
const [showUserButterflyModal, setShowUserButterflyModal] = useState(false)
const [userButterflyForm, setUserButterflyForm] = useState({
  label: '',
  hoverImg: '',
  modalImg: '',
  link: ''
})
```

### 8. 技术实现

#### 定时器管理
```typescript
useEffect(() => {
  const timers: number[] = [];
  for (let i = 0; i < BUTTERFLY_COUNT; i++) {
    const interval = butterflyFastArr[i] ? 120 : 320;
    timers[i] = window.setInterval(() => {
      setButterflyFramesState(prev => {
        const arr = [...prev];
        arr[i] = (arr[i] + 1) % butterflyFrames.length;
        return arr;
      });
    }, interval);
  }
  return () => { timers.forEach(t => window.clearInterval(t)); };
}, [butterflyFastArr]);
```

#### 位置计算算法
```typescript
function getRandomButterflyPositions() {
  const positions = [];
  let tries = 0;
  while (positions.length < BUTTERFLY_COUNT && tries < 200) {
    tries++;
    const left = Math.random() * 0.8 + 0.05;
    const top = Math.random() * 0.8 + 0.05;
    let overlap = false;
    for (let i = 0; i < positions.length; i++) {
      const dx = (left - positions[i].left) * mainImgMaxW * window.innerWidth;
      const dy = (top - positions[i].top) * mainImgMaxH * window.innerHeight;
      const minDist = (butterflySizes[positions.length].w + butterflySizes[i].w) / 2 + 12;
      if (dx * dx + dy * dy < minDist * minDist) {
        overlap = true;
        break;
      }
    }
    if (!overlap) positions.push({ left, top });
  }
  return positions;
}
```

## 用户体验

### 交互流程
1. 用户进入神域页面，看到随机夜晚场景
2. 场景中随机分布着几只官方七影蝶
3. 登录用户可在右下角看到自己的专属七影蝶
4. 鼠标悬停蝴蝶时，显示巡礼地点信息
5. 点击蝴蝶可查看详细信息或跳转外部链接
6. 点击"创建我的七影蝶"按钮可创建专属七影蝶
7. 点击刷新按钮可重新生成场景和蝴蝶

### 视觉反馈
- 蝴蝶翅膀持续扇动，营造生动感
- 悬停时翅膀加速，提供即时反馈
- 弹窗动画和阴影效果增强交互体验
- 星点浮动营造夜晚氛围
- 用户七影蝶金色边框突出显示

## 技术特点

1. **响应式设计**：适配不同屏幕尺寸
2. **性能优化**：使用定时器管理动画，避免内存泄漏
3. **用户体验**：丰富的视觉反馈和交互效果
4. **可扩展性**：配置化的蝴蝶系统，易于添加新的巡礼地点
5. **随机性**：每次刷新都有不同的体验
6. **个性化**：支持用户创建专属七影蝶
7. **数据持久化**：用户七影蝶数据存储在数据库中

## 文件结构

相关图片资源：
- `/images/webps/七影碟.webp` - 默认头像
- `/images/webps/七影碟-3.webp` - 蝴蝶动画帧1
- `/images/webps/七影碟-4.webp` - 蝴蝶动画帧2
- `/images/webps/男木岛/` - 男木岛相关场景图片
- `/images/webps/直岛/` - 直岛相关场景图片
- `/images/webps/女木岛/` - 女木岛相关场景图片
- `/uploads/butterflies/{user_id}/` - 用户七影蝶图片存储目录
